<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Osnap (osnap.Osnap)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">osnap</a> &#x00BB; Osnap</nav><h1>Module <code>Osnap</code></h1><h2 id="ocaml-random-snapshot-testing"><a href="#ocaml-random-snapshot-testing" class="anchor"></a>OCaml random snapshot testing</h2><nav class="toc"><ul><li><a href="#specifying-function-specification">Specifying function specification</a></li><li><a href="#test-creation">Test creation</a></li><li><a href="#runner">Runner</a></li></ul></nav></header><aside><p>The library takes inspiration from ppx_expect, we add random generators to store random application of functions. A snapshot will be the random applications on a function, the snapshot will be latter use to look for diffs between old and new version of a function.</p><ul><li><a href="Spec/index.html"><code>Spec</code></a> is used to give a function specification. <a href="Spec/index.html"><code>Spec</code></a> provides combinator to describe function generators and printer.</li></ul><p>Example:</p><pre><code class="ml">let spec_add = Osnap.Spec.(int ^&gt; int ^&gt;&gt; string_of_int)</code></pre><ul><li><a href="Test/index.html"><code>Test</code></a> is used to describe a single test, that is, where the snapshot will be stored and the function under test with its specification.</li></ul><p>Example:</p><pre><code class="ml">let test =
  let spec = Osnap.Spec.(int ^&gt; int ^&gt;&gt; int) in
  Osnap.Test.make ~path:&quot;.osnap/add&quot; ~spec (+)</code></pre><ul><li><a href="Runner/index.html"><code>Runner</code></a> is used to run tests.</li></ul><dl><dt>see <a href="https://github.com/janestreet/ppx_expect">https://github.com/janestreet/ppx_expect</a></dt><dd></dd></dl></aside><section><header><h3 id="specifying-function-specification"><a href="#specifying-function-specification" class="anchor"></a>Specifying function specification</h3><p>Spec takes inspiration from OCaml's property-based testing library Monolith. The idea is that the programmer describes the function specification through the set of generators from QCheck and a printer.</p><p>Examples:</p><ul><li>Addition specification:</li></ul><pre><code class="ml">let add = (+)
let spec_add = Spec.(int ^&gt; int ^&gt;&gt; string_of_int)</code></pre><ul><li>List sum specification:</li></ul><pre><code class="ml">let sum = List.fold_left ( + )
let spec_sum = list int ^&gt;&gt; string_of_int</code></pre></header><div class="spec module" id="module-Spec"><a href="#module-Spec" class="anchor"></a><code><span class="keyword">module</span> <a href="Spec/index.html">Spec</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section><section><header><h3 id="test-creation"><a href="#test-creation" class="anchor"></a>Test creation</h3></header><div class="spec module" id="module-Test"><a href="#module-Test" class="anchor"></a><code><span class="keyword">module</span> <a href="Test/index.html">Test</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section><section><header><h3 id="runner"><a href="#runner" class="anchor"></a>Runner</h3><p>Runner has tree mode:</p><ul><li>Interactive:</li></ul><p>Interactive mode provides an interactive runner, displaying differences between old and new snapshots. Promoting new version is proposed at every diff, exit when new diff is not promoted, considered as an error.</p><p>Example:</p><pre><code class="ml">let test =
  let spec = OSnap.Spec.(int ^&gt; int ^&gt;&gt; string_of_int) in
  Osnap.Test.make ~count:1 ~path:&quot;.osnap/add&quot; ~spec (+)

(* .osnap/add:

   f 5 6 = 11 *)

(* Then, the function under test is updated *)
let test =
  let spec = OSnap.Spec.(int ^&gt; int ^&gt;&gt; int) in
  Osnap.Test.make ~count:1 ~path:&quot;.osnap/add&quot; ~spec (fun _ _ -&gt; 0)

let _ = Runner.(run_tests ~mode:Interactive [test])

(* .osnap/add
   -| f 5 6 = 11;
   +| f 5 6 = 0

   Promote changes ? [Y\n] *)</code></pre><ul><li>Promote:</li></ul><p>Promote mode provides an automatic promotion of diffs.</p><p>Example:</p><pre><code class="ml">let test =
  let spec = OSnap.Spec.(int ^&gt; int ^&gt;&gt; int) in
  Osnap.Test.make ~count:1 ~path:&quot;.osnap/add&quot; ~spec (+)

(* .osnap/add:

   f 5 6 = 11; *)

(* Then, the function under test is updated *)
let test =
  let spec = OSnap.Spec.(int ^&gt; int ^&gt;&gt; int) in
  Osnap.Test.make ~count:1 ~path:&quot;.osnap/add&quot; ~spec (fun _ _ -&gt; 0)

let _ = Runner.(run_tests ~mode:Promote [test])

(* .osnap/add has been promoted
   -| f 5 6 = 11;
   +| f 5 6 = 0
*)</code></pre><ul><li>Error:</li></ul><p>Error mode will raise errors on diffs.</p><pre><code class="ml">let test =
  let spec = OSnap.Spec.(int ^&gt; int ^&gt;&gt; int) in
  Osnap.Test.make ~count:1 ~path:&quot;.osnap/add&quot; ~spec (+)

(* .osnap/add:

   f 5 6 = 11; *)

(* Then, the function under test is updated *)
let test =
  let spec = OSnap.Spec.(int ^&gt; int ^&gt;&gt; int) in
  Osnap.Test.make ~count:1 ~path:&quot;.osnap/add&quot; ~spec (fun _ _ -&gt; 0)

let _ = Runner.(run_tests ~mode:Promote [test])

(* .osnap/add has differences, exit
   -| f 5 6 = 11;
   +| f 5 6 = 0
*)</code></pre></header><div class="spec module" id="module-Runner"><a href="#module-Runner" class="anchor"></a><code><span class="keyword">module</span> <a href="Runner/index.html">Runner</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section></div></body></html>